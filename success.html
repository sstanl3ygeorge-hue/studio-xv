<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking Confirmed – Studio XV</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    :root {
      --bg-main: #000000;
      --text-main: #ffffff;
      --text-muted: #b5b5b5;
      --accent: #f97316;
      --success: #10b981;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-main: #ffffff;
        --text-main: #0b0b0b;
        --text-muted: #555555;
      }
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      font-family: system-ui, -apple-system, sans-serif;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes staggerIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #booking-details {
      animation: staggerIn 0.6s ease-out 0.2s both;
    }

    details {
      animation: staggerIn 0.6s ease-out 0.3s both;
    }

    .mb-8.text-left.max-w-lg.mx-auto.info-box:last-of-type {
      animation: staggerIn 0.6s ease-out 0.4s both;
    }

    /* Accessibility: disable animations for users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .info-box {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
    }

    @media (prefers-color-scheme: light) {
      .info-box {
        background: rgba(0, 0, 0, 0.03);
        border-color: rgba(0, 0, 0, 0.1);
      }
    }

    details summary span:first-child {
      transition: transform 0.2s ease;
      display: inline-block;
    }

    details[open] summary span:first-child {
      transform: rotate(90deg);
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center px-6 py-12">
  
  <div class="max-w-2xl w-full text-center fade-in">
    
    <div class="mb-6">
      <svg class="w-16 h-16 mx-auto" style="color: var(--success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>

    <h1 class="text-3xl md:text-4xl font-bold mb-3" id="page-title">
      Your Session is Confirmed
    </h1>

    <p class="text-lg mb-8" style="color: var(--text-muted);">
      <span id="customer-name">Thank you for booking with Studio XV.</span>
    </p>

    <!-- Session Details -->
    <div id="booking-details" class="mb-8 text-left max-w-lg mx-auto info-box">
      <h2 class="font-semibold text-lg mb-4 pb-3" style="border-bottom: 1px solid rgba(255,255,255,0.1);">Session Details</h2>
      <div class="space-y-3 mb-4">
        <div class="flex justify-between">
          <span style="color: var(--text-muted);">Service</span>
          <span id="service" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span style="color: var(--text-muted);">Package</span>
          <span id="package" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span id="duration-label" style="color: var(--text-muted);">Duration</span>
          <span id="hours" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span style="color: var(--text-muted);">Date</span>
          <span id="session-date" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span style="color: var(--text-muted);">Time</span>
          <span id="session-time" class="font-medium"></span>
        </div>
      </div>
      
      <div class="pt-4 space-y-2" style="border-top: 1px solid rgba(255,255,255,0.1);">
        <div id="payment-status" class="flex items-center gap-2 mb-3 text-xs" style="color: var(--success); display: none;">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="font-medium">Payment Status: Paid in full</span>
        </div>
        <div class="flex justify-between text-lg">
          <span class="font-semibold">Total Session Price</span>
          <span id="total" class="font-semibold"></span>
        </div>
        <div class="flex justify-between" id="payment-row">
          <span id="payment-label" style="color: var(--text-muted);"></span>
          <span id="payment-amount" style="color: var(--success);" class="font-medium"></span>
        </div>
        <div class="flex justify-between" id="balance-row">
          <span style="color: var(--text-muted);">Balance Due</span>
          <span id="balance" class="font-bold" style="color: var(--accent);"></span>
        </div>
      </div>
    </div>

    <!-- What to Prepare (Session bookings only) -->
    <details id="what-to-prepare" class="mb-8 text-left max-w-lg mx-auto info-box" style="cursor: pointer;">
      <summary class="font-semibold text-lg mb-3" style="list-style: none; display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.25rem;">▸</span>
        <span>What to Prepare</span>
      </summary>
      <div class="mt-3 space-y-2 text-sm" style="color: var(--text-muted);">
        <p>• <strong style="color: var(--text-main);">Bring reference tracks</strong> – Songs that inspire your sound</p>
        <p id="arrive-early-tip">• <strong style="color: var(--text-main);">Arrive 10 minutes early</strong> – Time to settle in and discuss the session</p>
        <p>• <strong style="color: var(--text-main);">Export stems if mixing</strong> – Individual tracks, properly labeled</p>
        <p>• <strong style="color: var(--text-main);">Save at original sample rate</strong> – Typically 44.1kHz or 48kHz</p>
      </div>
    </details>

    <!-- Production Purchase Confirmation (Full payment only) -->
    <div id="production-confirmation" class="mb-8 text-left max-w-lg mx-auto info-box" style="display: none;">
      <h2 class="font-semibold text-lg mb-3">Purchase Confirmed</h2>
      <p class="text-sm" style="color: var(--text-muted);">
        Your purchase is confirmed. We'll email delivery and license details shortly.
      </p>
    </div>

    <!-- Next Steps -->
    <div class="mb-8 text-left max-w-lg mx-auto info-box">
      <h2 class="font-semibold text-lg mb-3">What Happens Next</h2>
      <div class="space-y-3 text-sm" style="color: var(--text-muted);">
        <div class="flex gap-3">
          <span class="font-bold" style="color: var(--accent);">1.</span>
          <p><strong style="color: var(--text-main);">Confirmation email sent</strong> – Check your inbox for booking details and a calendar invite.</p>
        </div>
        <div class="flex gap-3">
          <span class="font-bold" style="color: var(--accent);">2.</span>
          <p><strong style="color: var(--text-main);">We'll be in touch</strong> – Expect a message from us within 24 hours to finalize any last details.</p>
        </div>
        <div class="flex gap-3" id="balance-step">
          <span class="font-bold" style="color: var(--accent);">3.</span>
          <p><strong style="color: var(--text-main);">Balance payment</strong> – Balance due at session start. We'll send a payment link 48 hours before.</p>
        </div>
        <div class="flex gap-3" id="session-day-step">
          <span class="font-bold" style="color: var(--accent);" id="final-step-number">3.</span>
          <p><strong style="color: var(--text-main);" id="final-step-title">Session day</strong> – <span id="final-step-text">Arrive ready to create. We'll handle the rest.</span></p>
        </div>
      </div>
    </div>

    <a href="/"
       class="inline-block px-8 py-4 rounded-lg font-semibold transition hover:opacity-90"
       style="background: var(--accent); color: white;">
      Return to Studio XV
    </a>

  </div>

  <script>
    // Fetch booking data from Stripe via Netlify function
    async function loadBookingData() {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session_id');

      if (!sessionId) {
        console.error('No session_id in URL');
        document.getElementById('customer-name').textContent = 'Your session has been secured.';
        return;
      }

      try {
        const response = await fetch(`/.netlify/functions/get-booking?session_id=${sessionId}`);
        const data = await response.json();

        if (!data.success || !data.booking) {
          throw new Error('Failed to load booking data');
        }

        const booking = data.booking;

        // Populate UI with REAL data from Stripe (no calculations)
        const customerName = booking.customerName || 'there';
        document.getElementById('customer-name').textContent = 
          `Thank you, ${customerName}. Your booking is confirmed.`;
        
        document.getElementById('service').textContent = booking.service || 'N/A';
        document.getElementById('package').textContent = booking.packageName || 'N/A';
        document.getElementById('hours').textContent = booking.durationLabel || 'Duration to be confirmed';
        
        // Update Duration label to Product if service is Production or full payment
        const durationLabel = document.getElementById('duration-label');
        if (booking.service === 'Production' || booking.emailType === 'full_payment') {
          durationLabel.textContent = 'Product';
        }
        document.getElementById('session-date').textContent = booking.sessionDateFormatted || booking.sessionDate || 'To be confirmed';
        document.getElementById('session-time').textContent = booking.sessionTimeFormatted || booking.sessionTime || 'To be confirmed';
        document.getElementById('total').textContent = `£${(booking.total || 0).toFixed(2)}`;

        // Use emailType from BookingSnapshot to determine payment scenario
        const emailType = booking.emailType || 'deposit_paid'; // fallback to deposit
        const isFullPayment = emailType === 'full_payment';
        
        const balanceDue = booking.balanceDue || 0;
        const amountPaid = booking.deposit || booking.totalPaid || 0;

        // Update payment label and amount
        const paymentLabel = document.getElementById('payment-label');
        const paymentAmount = document.getElementById('payment-amount');
        const balanceRow = document.getElementById('balance-row');
        const balanceStep = document.getElementById('balance-step');
        const finalStepNumber = document.getElementById('final-step-number');
        const paymentStatus = document.getElementById('payment-status');
        const whatToPrepare = document.getElementById('what-to-prepare');
        const productionConfirmation = document.getElementById('production-confirmation');
        const pageTitle = document.getElementById('page-title');
        const sessionDayStep = document.getElementById('session-day-step');
        const finalStepTitle = document.getElementById('final-step-title');
        const finalStepText = document.getElementById('final-step-text');
        const arriveEarlyTip = document.getElementById('arrive-early-tip');

        if (isFullPayment) {
          // Full payment scenario (emailType === 'full_payment') - Production/beat purchase
          pageTitle.textContent = 'Purchase Confirmed';
          paymentStatus.style.display = 'flex'; // Show payment status
          paymentLabel.textContent = 'Amount Paid Today';
          paymentAmount.textContent = `£${amountPaid.toFixed(2)}`;
          balanceRow.style.display = 'none'; // Hide balance row
          balanceStep.style.display = 'none'; // Hide balance payment step
          finalStepNumber.textContent = '3'; // Update numbering
          whatToPrepare.style.display = 'none'; // Hide session prep for production
          productionConfirmation.style.display = 'block'; // Show production message
          finalStepTitle.textContent = 'Delivery'; // Change from "Session day"
          finalStepText.textContent = "We'll send your files and license via email.";
        } else {
          // Deposit scenario (emailType === 'deposit_paid') - Session booking
          whatToPrepare.open = true; // Open by default for sessions
          paymentLabel.textContent = 'Deposit Paid Today';
          paymentAmount.textContent = `£${amountPaid.toFixed(2)}`;
          document.getElementById('balance').textContent = `£${balanceDue.toFixed(2)}`;
          balanceRow.style.display = 'flex';
          balanceStep.style.display = 'flex';
          finalStepNumber.textContent = '4';
        }

      } catch (error) {
        console.error('Error loading booking:', error);
        document.getElementById('customer-name').textContent = 'Your session has been secured. Check your email for details.';
      }
    }

    // Load data on page load
    loadBookingData();
  </script>

</body>
</html>
